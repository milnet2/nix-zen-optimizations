== Compile programs optimized for Zen using nix

Contains facilities for building packages on https://nixos.org/[Nix-based] *Linux* systems with an AMD Ryzen CPU.

The intended use of it is through an "alternative" `pkgs` from the system like:

[source,nix]
----
# Where this would be your regular one
pkgs = import <nixpkgs> {};

# There can be an additional (short variant):
pkgsTuned = import ./zen-optimized-pkgs.nix {
    importablePkgsDelegate = <nixpkgs>;
    amdZenVersion = 2;
    };
----

The mechanism tries to use the (unoptimized) compilers present on the system and create optimized binaries from the packages to install.

See xref:docu/zen-optimized-pkgs.adoc[] for the full description of parameters.

=== Disclaimer

Here is why you should *not* use the repo:

* The repo is *unmaintained!* - I've just not the time to take care of it
** I thought it was easier - it's not - things will break quite easily. Expect to invest quite some time.
** There's still a lot missing / not optimized - see also https://github.com/milnet2/nix-zen-optimizations/issues[issues]
* There are likely better alternatives - check out
** Specific OCI/Docker images for the stuff you'll want optimized
** Official https://github.com/ROCm/TheRock[AMD TheRock] which also has Docker-images as basis
** Nix packages under `pkgs.rocmPackages` and where it's from https://github.com/nixos-rocm/nixos-rocm[nixos-rocm (now obsolete)]
* You'll be compiling a lot - think twice if it's worth it



=== Covered languages

The implementation covers the following languages:

[cols="1,3,2"]
|===
|Language |Mechanism |Status

| C                     | Wrapper-script around system `gcc`        a|
* [yellow]#⚠# Not all optimizations applied properly
* ✅ tests pass - #double check#
| C++                   | Wrapper-script around system `gcc`        a|
* [yellow]#⚠# Not all optimizations applied properly
* ✅ tests pass - #double check#
| Go                    | Wrapper-script around system `go` and `buildGoModule` setting `GOAMD64`  a|
* ✅ tests pass
| Rust                  | Wrapper-script around system `rustc` and `cargo` a|
* ✅ tests pass
| Python 3 (minimal)    | Interpreter compiled with optimizations   a|
* [yellow]#⚠# Should prefer local build because of optimizations
* ✅ tests pass
* [yellow]#⚠# Tests should be more specific on optimizations
| Fortran               | Wrapper-script around system `gfortran`   a|
* ✅ tests pass
| Haskell               | Wrapped system `ghc` but recompiled with LLVM support a|
* [yellow]#⚠# Test's don't really test anything
| R                     | Recompiled interpreter                    a|
* ✅ Use Zen-optimized _BLAS_ and _LAPACK_
* [yellow]#⚠# Many optimizations not applied to interpreter (compile error)
* [yellow]#⚠# Test's don't really test anything
* ❌ Nix `checkPhase` is disabled due to regressions
|===

=== Picked libraries

The implementation use the following libraries:

[cols="1,3,2"]
|===
|Library |Mechanism |Status

| blas                  | provided through https://github.com/NixOS/nixpkgs/blob/nixos-25.05/pkgs/by-name/am/amd-blis/package.nix[amd-blis]                   a|
* Used by
** _R_
* Set to proper Zen-version
* Uses unoptimized "parent" `CC`
| lapack                | provided through https://github.com/NixOS/nixpkgs/blob/nixos-25.05/pkgs/by-name/am/amd-libflame/package.nix[amd-libflame]           a|
* Used by
** _R_
* Uses optimized `CC` from above
|===
