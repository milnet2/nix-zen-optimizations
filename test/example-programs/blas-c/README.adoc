== BLAS example program

A simple long-running BLAS job needing not a lot of memory.

- Performs multiple single-precision matrix multiplication (`SGEMM`): C = A Ã— B with row-major layout, no transposes, alpha=1, beta=0.
- Repeats the `GEMM` operation a configurable number of times and measures only the time spent inside the GEMM calls.
- Supports a CPU backend (CBLAS via OpenBLAS/BLIS/MKL) and an optional GPU backend (rocBLAS/HIP). The backend is selected at build time via the Nix attributes (`isCpu`) and available libraries.

Example JSON result:

[source,json]
----
{
  "engine": {"name":"BLIS","version":"..."},
  "input": {"M":4096,"N":4096,"K":4096,"repeats":100,"expected_bytes_total":201326592,"expected_megabytes_total":192.0},
  "output": {"time_sec": 23.435000, "gflops": 586.46, "checksum": -2304.952393}
}
----

On failures (e.g., when a GPU handle cannot be created), the program still prints a JSON object with an "error" field along with the input and engine information.

=== Building with Nix

CPU::
[source,bash]
----
nix-build -E 'with import <nixpkgs> {}; callPackage ./default.nix { isCpu = true; }' && \
./result/bin/blas-test 4096 4096 100
----

Example output:

----
Problem: M=4096 N=4096 K=4096  repeats=100  (~192.0 MB)
Time: 23.435 s   Perf: 586.46 GFLOP/s   Checksum: -2304.952393
----

CAUTION:: Ensure the bls-kernel is available by running `/nix/store/xaqbdlsfllp4mnh6vx6vbppxfad44dva-rocblas-6.3.3/` and looking this up in
"_/nix/store/*-rocblas-6.3.3/lib/rocblas/library/_"

GPU (CC)::
[source,bash]
----
nix-build -E 'with import <nixpkgs> {}; callPackage ./default.nix { isCpu = false; rocblas = rocmPackages.rocblas; clr = rocmPackages.clr; }' && \
./result/bin/blas-test 4096 4096 100
----

GPU (HIP)::
[source,bash]
----
nix-build -E 'with import <nixpkgs> {}; callPackage ./default.nix { isCpu = false; rocblas = rocmPackages.rocblas; hipcc = rocmPackages.hipcc; clr = rocmPackages.clr; }' && \
./result/bin/blas-test 4096 4096 100
----

==== Spoofing GPU

This is a hack if the GPU isn't officially supported:

[source,bash]
----
HSA_OVERRIDE_GFX_VERSION=9.0.0 ./result/bin/blas-test 4096 4096 100
----

Example output:

----
Problem: M=4096 N=4096 K=4096  repeats=100  (~192.0 MB)
Time: 12.223 s   Perf: 1124.43 GFLOP/s   Checksum: -2304.831055
----

=== Using Optimized Nix (with Zen optimizations)

To build the program with the optimized Nix setup from this repository:

CPU::
[source,bash]
----
nix-build -E 'with import ./../../../zen-optimized-pkgs.nix {}; callPackage ./default.nix { isCpu = true; }' && \
./result/bin/blas-test 4096 4096 100
----

Example output:

----
Problem: M=4096 N=4096 K=4096  repeats=100  (~192.0 MB)
Time: 24.693 s   Perf: 556.60 GFLOP/s   Checksum: -2304.965576
----

GPU (CC)::
[source,bash]
----
nix-build -E 'with import ./../../../zen-optimized-pkgs.nix {}; callPackage ./default.nix { isCpu = false; rocblas = rocmPackages.rocblas; clr = rocmPackages.clr; }' && \
./result/bin/blas-test 4096 4096 100
----

GPU (HIP)::
[source,bash]
----
nix-build -E 'with import ./../../../zen-optimized-pkgs.nix {}; callPackage ./default.nix { isCpu = false; rocblas = rocmPackages.rocblas; hipcc = rocmPackages.hipcc; clr = rocmPackages.clr; }' && \
./result/bin/blas-test 4096 4096 100
----